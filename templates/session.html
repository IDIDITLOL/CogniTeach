<!DOCTYPE html>
<html>
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <!-- </speechsdkref> -->

  <!-- <quickstartcode> -->
  <!-- Speech SDK USAGE -->
  <script>
    // status fields and start button in UI
    var phraseDiv;
    var startRecognizeOnceAsyncButton;

    // subscription key and region for speech services.
    var subscriptionKey, serviceRegion;
    var SpeechSDK;
    var recognizer;

    document.addEventListener("DOMContentLoaded", function () {
      startRecognizeOnceAsyncButton = document.getElementById("startRecognizeOnceAsyncButton");
      subscriptionKey = "8f0b068bc2f246509f2b26884bf739ee";
      serviceRegion = "eastus";
      phraseDiv = document.getElementById("phraseDiv");

      startRecognizeOnceAsyncButton.addEventListener("click", function () {
        startRecognizeOnceAsyncButton.disabled = true;
        phraseDiv.innerHTML = "";

        if (subscriptionKey.value === "" || subscriptionKey.value === "subscription") {
          alert("Please enter your Microsoft Cognitive Services Speech subscription key!");
          return;
        }
        var speechConfig = SpeechSDK.SpeechConfig.fromSubscription(subscriptionKey, serviceRegion);

        speechConfig.speechRecognitionLanguage = "en-US";
        var audioConfig  = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

        recognizer.recognizeOnceAsync(
          function (result) {
            startRecognizeOnceAsyncButton.disabled = false;
            phraseDiv.innerHTML += result.text;
            window.console.log(result);

            recognizer.close();
            recognizer = undefined;
          },
          function (err) {
            startRecognizeOnceAsyncButton.disabled = false;
            phraseDiv.innerHTML += err;
            window.console.log(err);

            recognizer.close();
            recognizer = undefined;
          });
      });

      if (!!window.SpeechSDK) {
        SpeechSDK = window.SpeechSDK;
        startRecognizeOnceAsyncButton.disabled = false;
      }

    const audioElement = document.getElementById('synthesizedAudio');
    const textDisplay = document.getElementById('textDisplay');
    let textToSpeak = "{{lecture}}"; // Replace this with the text you want to speak

    function speakAndDisplayText(text, callback) {
        const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(subscriptionKey, serviceRegion);
        const speechSynthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig);
        speechConfig.speechSynthesisVoiceName = "en-US-EmmaNeural";

        speechSynthesizer.speakTextAsync(
            text,
            result => {
                speechSynthesizer.close();
                const blob = new Blob([result.audioData], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                audioElement.src = url;
                updateTextAsAudioPlays(text);
                if (callback) {
                    callback(); // Invoke the callback function when text-to-speech is completed
                }
            },
            error => {
                console.log(error);
                speechSynthesizer.close();
            }
        );
    }
    function updateTextAsAudioPlays(text) {
        let words = text.split(' '); // Split text into words
        let currentWordIndex = 0;
        let wordsPerDisplay = 5; // Number of words to display at a time
        let displayDuration = 2000; // Display duration for each set of words (in milliseconds)

        function displayWordsChunk() {
            let displayWords = words.slice(currentWordIndex, currentWordIndex + wordsPerDisplay).join(' ');
            textDisplay.textContent = displayWords;
            currentWordIndex += wordsPerDisplay;

            if (currentWordIndex < words.length) {
                setTimeout(displayWordsChunk, displayDuration);
            }
        }

        audioElement.addEventListener('timeupdate', function () {
            let currentTime = audioElement.currentTime;

            if (currentTime >= audioElement.duration) {
                textDisplay.textContent = '';
                return;
            }

            if (currentWordIndex === 0) {
                displayWordsChunk();
            }
        });
    }

    speakAndDisplayText(textToSpeak);
    
    const imageSets = [
        {% for image_set in images %}
        [
            {% for url in image_set %}
            '{{ url }}',
            {% endfor %}
        ],
        {% endfor %}
    ];
    const textSets = [
        {% for text_set in board_writings %}
        
            '{{ text_set }}',
        {% endfor %}
        
    ];
    let textIndex = 0; // Global variable to keep track of the current text in the list
    var textContent = ''; // Global variable to hold the text content
    const hmmKeyword = 'hmm';
    var hmmDetected = false;

    var currentImageIndex = 0;
    const ummKeyword = 'umm';
    var ummDetected = false;
    function displayText(newText) {
      console.log("There fore I am not.")
      const textDisplay = document.getElementById('BoardText');
      textContent += newText;
      textDisplay.innerHTML = textContent;
    }
    function updateTextOnKeyword(subtitles) {
      console.log("Therefore, I am")
      if (subtitles.includes(hmmKeyword) && !hmmDetected) {
          hmmDetected = true;
          const newText = textSets[textIndex];
          textIndex = (textIndex + 1) % textSets.length; // Update the index for the next text
          displayText(newText);
          // Perform any other actions here when keyword is detected
      } else if (!subtitles.includes(hmmKeyword) && hmmDetected) {
          hmmDetected = false;
        // Perform any other actions here when keyword disappears
      }
    }
    function displayImages(images) {
        const image1 = document.getElementById('img1');
        const image2 = document.getElementById('img2');
        const image3 = document.getElementById('img3');
        image1.src=images[currentImageIndex][0];
        image2.src=images[currentImageIndex][1];
        image3.src=images[currentImageIndex][2];
        currentImageIndex = (currentImageIndex + 1) % images.length;
    }

    function updateDisplayOnKeyword(subtitles) {
      if (subtitles.includes(ummKeyword) && !ummDetected) {
          ummDetected = true;
          displayImages(imageSets); // Pass the correct imageSets variable here
      } else if (!subtitles.includes(ummKeyword) && ummDetected) {
          ummDetected = false;
      }
    }
    setInterval(function () {
        const currentSubtitle = document.getElementById('textDisplay').textContent.trim();
        updateDisplayOnKeyword(currentSubtitle);
        updateTextOnKeyword(currentSubtitle);
    }, 1000);
    $('a#process_input').bind('click', function(event) {
      event.preventDefault();
      $.getJSON('/askgpt', {
        phraseDiv: $('textarea[name="phraseDiv"]').val(),
      }, function(data) {
        $("#resulter").text(data.result);
        audioElement.pause();
                // Play the new text-to-speech result
        speakAndDisplayText(data.result, function() {
                    // Resume playing the synthesized audio when text-to-speech is completed
            audioElement.play();
      });
    });
    });
  });
  </script>

<body>
<button id="startRecognizeOnceAsyncButton">Speech to Text</button>
<textarea id="phraseDiv" name="phraseDiv" style="display: inline-block; width: 500px; height: 200px"></textarea>
<a href="#" id="process_input"><button class="btn btn-default">Ask</button></a>
<div id="resulter">hehehe</div>
<audio id="synthesizedAudio" autoplay controls></audio>
<div id="imageDisplay">
  <img id="img1" width="200" height="150">
  <img id="img2" width="200" height="150">
  <img id="img3" width="200" height="150">
</div>
<div><p id="BoardText">allah ho akbar</p></div>
<p id="textDisplay">uwu</p>
</body>
</html>
